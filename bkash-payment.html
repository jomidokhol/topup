<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="google" content="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bKash Payment - Vercel top up</title>
    <style>
        /* ফন্ট ইমপোর্ট (গুগল ফন্টস থেকে - বাংলার জন্য) */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;600;700&display=swap');

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans Bengali', sans-serif;
        }

        body {
            /* পেছনের প্যাটার্ন ব্যাকগ্রাউন্ড */
            background-color: #f4f6f9;
            background-image: 
                radial-gradient(#e0e0e0 1px, transparent 1px),
                radial-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding-top: 20px;
        }

        /* মেইন কন্টেইনার */
        .container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            padding-bottom: 20px;
        }

        /* হেডার আইকন */
        .header-icons {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            align-items: center;
        }
        .header-icons span {
            color: #5f6368;
            cursor: pointer;
            font-size: 18px;
        }

        /* লোগো সেকশন */
        .logo-section {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo-section img {
            width: 240px; /* বিকাশের লোগো সাইজ */
        }

        /* ওয়ালেট এবং টাকার বক্স */
        .white-box {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-weight: 600;
            color: #444;
        }
        .wallet-icon {
            width: 30px;
            height: 30px;
            margin-right: 15px;
            border: 1px solid #ddd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #999;
        }

        /* পিংক ব্যাকগ্রাউন্ড সেকশন (বিকাশ) */
        .pink-card {
            background-color: #d12053; /* বিকাশের অফিসিয়াল পিংক কালার */
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            margin-top: 10px;
            position: relative;
        }

        .section-title {
            text-align: center;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
        }

        /* ইনপুট ফিল্ড */
        .input-group {
            margin-bottom: 20px;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border-radius: 5px;
            border: none;
            font-size: 14px;
            outline: none;
        }
        .input-group input::placeholder {
            color: #999;
        }

        /* ইন্সট্রাকশন লিস্ট */
        .instructions {
            list-style: none;
            font-size: 13px;
            line-height: 1.6;
        }
        .instructions li {
            position: relative;
            padding-left: 15px;
            margin-bottom: 12px;
        }
        .instructions li::before {
            content: "•";
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        /* হাইলাইট টেক্সট */
        .highlight-yellow {
            color: #ffe600;
            font-weight: bold;
        }

        /* কপি বাটন */
        .copy-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 5px;
            display: inline-flex;
            align-items: center;
        }
        .copy-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* ভেরিফাই বাটন - লাল রঙের */
        .verify-btn {
            width: 100%;
            background-color: #d32f2f; /* ইমেজের মতো গাঢ় লাল */
            color: white;
            border: none;
            padding: 15px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .verify-btn:hover {
            background-color: #b71c1c;
        }
        .verify-btn:disabled {
            background-color: #e57373;
            cursor: not-allowed;
        }
        
    </style>
</head>
<body>

<div class="container">
    
    <!-- উপরের নেভিগেশন বার -->
    <div class="header-icons">
        <span onclick="goBack()">&#8592;</span>
        <div style="display: flex; gap: 15px;">
            <span>Vercel Top Up</span>
            <span onclick="goBack()">&#10005;</span>
        </div>
    </div>

    <!-- লোগো -->
    <div class="logo-section">
        <!-- বিকাশের লোগো -->
        <img src="https://i.ibb.co.com/1GDqN06T/5db8198b939c391189fd7be0038c16b6.png" alt="bKash Logo">
    </div>

    <!-- ওয়ালেট -->
    <div class="white-box">
        <div class="wallet-icon">
            <img src="https://i.ibb.co.com/1GDqN06T/5db8198b939c391189fd7be0038c16b6.png" alt="" style="width: 15px; opacity: 0.5;">
        </div>
        <span>Bkash pay</span>
    </div>

    <!-- টাকার পরিমাণ -->
    <div class="white-box" id="amountDisplayBox">
        ৳ <span id="mainAmountDisplay">loading...</span>
    </div>

    <!-- পিংক কার্ড (বিকাশ) -->
    <div class="pink-card">
        <div class="section-title">ট্রানজেকশন আইডি দিন</div>

        <div class="input-group">
            <input type="text" id="trxID" placeholder="ট্রানজেকশন আইডি দিন">
        </div>

        <ul class="instructions">
            <li>*247# ডায়াল করে আপনার bKash মোবাইল মেনুতে যান অথবা bKash অ্যাপে যান।</li>
            <li>"<span class="highlight-yellow">Send Money</span>" -এ ক্লিক করুন।</li>
            <li>
                প্রাপক নম্বর হিসেবে এই নম্বরটি লিখুনঃ <span class="highlight-yellow" id="adminNumberDisplay">loading...</span>
                <button class="copy-btn" onclick="copyNumber()">Copy
                </button>
            </li>
            <li>টাকার পরিমাণঃ <span class="highlight-yellow" id="instructionAmountDisplay">loading...</span></li>
            <li>নিশ্চিত করতে এখন আপনার bKash মোবাইল মেনু পিন লিখুন।</li>
            <li>সবকিছু ঠিক থাকলে, আপনি bKash থেকে একটি নিশ্চিতকরণ বার্তা পাবেন।</li>
            <li>এখন উপরের বক্সে আপনার <span class="highlight-yellow">Transaction ID</span> দিন এবং নিচে <span class="highlight-yellow">VERIFY</span> বাটনে ক্লিক করুন।</li>
        </ul>
    </div>

    <!-- ভেরিফাই বাটন -->
    <button class="verify-btn" id="verifyBtn" onclick="verifyPayment()">VERIFY</button>

</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCZrkWD_5YQW0P-3SYhAzSE4pbCyTqvYu8",
      authDomain: "topupshopnur.firebaseapp.com",
      projectId: "topupshopnur",
      storageBucket: "topupshopnur.firebasestorage.app",
      messagingSenderId: "25262245834",
      appId: "1:25262245834:web:5a867f0516b120bfbcb133",
      measurementId: "G-QR5PYZDCG8"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let pendingOrder = JSON.parse(localStorage.getItem('pendingOrder'));

    // Init Logic
    window.onload = function() {
        if (!pendingOrder) {
            alert("কোন অর্ডার পাওয়া যায়নি।");
            window.location.href = 'topup.html';
            return;
        }

        // Update UI with Data
        const formattedAmount = parseFloat(pendingOrder.totalPrice).toFixed(2);
        document.getElementById('mainAmountDisplay').innerText = formattedAmount;
        document.getElementById('instructionAmountDisplay').innerText = formattedAmount;
        document.getElementById('adminNumberDisplay').innerText = pendingOrder.paymentNumber;
    };

    function goBack() {
        window.location.href = 'topup.html';
    }

    function copyNumber() {
        if(pendingOrder && pendingOrder.paymentNumber) {
            navigator.clipboard.writeText(pendingOrder.paymentNumber).then(() => {
                alert('নম্বরটি কপি করা হয়েছে: ' + pendingOrder.paymentNumber);
            });
        }
    }

    async function verifyPayment() {
        const trxID = document.getElementById('trxID').value.trim();
        const btn = document.getElementById('verifyBtn');

        if (!trxID) {
            alert("অনুগ্রহ করে ট্রানজেকশন আইডি দিন।");
            return;
        }

        btn.disabled = true;
        btn.innerText = "যাচাইকরণ চলছে...";

        // Prepare Final Order Data
        let orderData = {
            userId: pendingOrder.userId,
            game: pendingOrder.gameName,
            package: pendingOrder.packageAmount,
            quantity: pendingOrder.quantity,
            price: parseFloat(pendingOrder.totalPrice),
            playerId: pendingOrder.playerId,
            paymentMethod: pendingOrder.paymentMethodName,
            adminNumber: pendingOrder.paymentNumber,
            userPaymentNumber: "Manual Input", // Since users pay via gateway app, user number is often unknown unless asked.
            transactionId: trxID,
            status: 'Pending',
            date: firebase.firestore.FieldValue.serverTimestamp()
        };

        const gameRef = db.collection('games').doc(pendingOrder.gameId);

        try {
            await db.runTransaction(async (transaction) => {
                const gameDoc = await transaction.get(gameRef);
                if (!gameDoc.exists) throw "এই প্রোডাক্টটি এখন আর পাওয়া যাচ্ছে না।";

                const gameData = gameDoc.data();
                const packages = gameData.packages || [];
                // Find matching package based on amount and price
                const packageIndex = packages.findIndex(p => p.amount === pendingOrder.packageAmount && p.price === pendingOrder.packagePrice);
                
                if (packageIndex === -1) throw "এই প্যাকেজটি এখন আর পাওয়া যাচ্ছে না।";
                
                const currentStock = parseInt(packages[packageIndex].stock);
                if (isNaN(currentStock) || currentStock < pendingOrder.quantity) throw "দুঃখিত! স্টকে পর্যাপ্ত পরিমাণ নেই।";

                // Deduct Stock
                packages[packageIndex].stock = currentStock - pendingOrder.quantity;
                transaction.update(gameRef, { packages: packages });
                
                // Create Order
                transaction.set(db.collection('orders').doc(), orderData);
            });

            // Success
            localStorage.setItem('lastOrder', JSON.stringify(orderData));
            localStorage.removeItem('pendingOrder'); // Clear temp data
            window.location.href = 'order-confirmation.html';

        } catch (error) {
            alert("সমস্যা হয়েছে: " + (error.message || error));
            btn.disabled = false;
            btn.innerText = "VERIFY";
        }
    }
</script>

</body>
</html>