<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="google" content="notranslate">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Vercel Topup</title>
<!-- Google Fonts & Font Awesome -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<!-- iPhone Style Font Implementation -->
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
:root {
--primary-purple: #7B61FF;
--light-purple: #E9E7FF;
/* Light Mode Colors */
--background-color: #F5F5F7; /* Apple style light gray adjusted */
--card-bg-color: #ffffff;
--primary-text-color: #1D1D1F;
--secondary-text-color: #86868B;
--accent-green: #34C759;
--accent-red: #FF3B30;
--border-radius-large: 20px;
--border-radius-medium: 14px;
--soft-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
--nav-shadow: 0 -5px 20px rgba(0,0,0,0.05);
/* iPhone System Font Stack */
--font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}
/* 3. ডার্ক মোড ডিপ ব্লাক */
    body.dark-mode {
        --background-color: #000000; /* Deep Black */
        --card-bg-color: #1C1C1E; /* Apple Dark Mode Card Color */
        --primary-text-color: #F5F5F7;
        --secondary-text-color: #8E8E93;
        --light-purple: #2C2C2E;
        --soft-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        --nav-shadow: 0 -5px 20px rgba(255,255,255,0.05);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: var(--font-family);
        background-color: var(--background-color);
        color: var(--primary-text-color);
        height: 100vh;
        overflow: hidden;
        transition: background-color 0.3s, color 0.3s;
        -webkit-font-smoothing: antialiased; /* Smoother fonts for iOS */
    }

    .auth-container, .app-container {
        position: relative; width: 100%; height: 100vh;
        max-width: 480px; margin: auto; overflow: hidden;
        background-color: var(--background-color);
    }
    .app-container { display: none; }

    /* Screen Transitions */
    .screen {
        position: absolute; top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: var(--background-color);
        transform: translateX(100%);
        transition: transform 0.35s cubic-bezier(0.25, 0.1, 0.25, 1);
        overflow-y: auto; padding: 20px;
        /* FIX 1: Increased padding-bottom so nav bar doesn't hide content */
        padding-bottom: 120px; 
        scrollbar-width: none; /* Hide scrollbar Firefox */
    }
    .screen::-webkit-scrollbar { display: none; } /* Hide scrollbar Chrome */
    
    .screen.active { transform: translateX(0); }
    #homeScreen, #loginScreen { transform: translateX(0); }

    /* Auth Styles */
    .auth-container { display: flex; align-items: center; justify-content: center; padding: 25px; }
    .auth-wrapper { width: 100%; }
    .auth-logo-container { text-align: center; margin-bottom: 40px; }
    .auth-logo-container h1 { font-size: 36px; font-weight: 800; color: var(--primary-purple); letter-spacing: -1px; }
    
    .auth-form { width: 100%; padding: 35px 25px; border-radius: var(--border-radius-large); background-color: var(--card-bg-color); box-shadow: var(--soft-shadow); }
    .auth-form h2 { text-align: center; margin-bottom: 30px; font-weight: 700; color: var(--primary-text-color); font-size: 24px; }
    
    .input-group { margin-bottom: 20px; }
    .input-group input { 
        width: 100%; padding: 18px; 
        background-color: var(--background-color); 
        border: 1px solid transparent; 
        border-radius: var(--border-radius-medium); 
        font-size: 15px; 
        color: var(--primary-text-color);
        transition: all 0.2s;
    }
    .input-group input:focus { border-color: var(--primary-purple); background-color: var(--card-bg-color); outline: none; box-shadow: 0 0 0 4px rgba(123, 97, 255, 0.1); }
    
    .auth-form .form-link { text-align: center; margin-top: 25px; font-size: 14px; color: var(--secondary-text-color); }
    .auth-form .form-link span { color: var(--primary-purple); cursor: pointer; font-weight: 600; }

    /* Buttons */
    .btn { 
        display: block; width: 100%; 
        background: var(--primary-purple); 
        color: white; border: none; 
        padding: 18px; 
        border-radius: var(--border-radius-medium); 
        font-size: 16px; font-weight: 600; 
        cursor: pointer; text-align: center; 
        transition: all 0.2s; 
        box-shadow: 0 8px 20px rgba(123, 97, 255, 0.25); 
    }
    .btn:active { transform: scale(0.98); }
    .btn-danger { background: var(--accent-red); box-shadow: 0 8px 20px rgba(255, 59, 48, 0.25); }
    .btn-secondary { background: var(--secondary-text-color); box-shadow: none; }
    .action-buttons { display: flex; gap: 10px; margin-top: 20px; margin-bottom: 10px;}

    /* Header Styles */
    .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 5px; margin-bottom: 10px; }
    .header-brand { display: flex; align-items: center; gap: 12px; }
    .header-logo { width: 42px; height: 42px; border-radius: 12px; object-fit: cover; background-color: var(--primary-purple); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .header-title { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; color: var(--primary-text-color); }
    .header .profile-avatar { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 2px solid var(--card-bg-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .header-right-icons { display: flex; align-items: center; gap: 15px; }

    /* 4. Marquee - Custom CSS Animation */
    .marquee-wrapper {
        background-color: var(--card-bg-color);
        padding: 10px 0;
        border-radius: var(--border-radius-medium);
        margin-bottom: 25px;
        box-shadow: var(--soft-shadow);
        overflow: hidden;
        position: relative;
        white-space: nowrap;
    }
    .marquee-content {
        display: inline-block;
        font-size: 14px;
        font-weight: 500;
        color: var(--primary-text-color);
        padding-left: 100%; /* Start from right */
        animation: marquee 15s linear infinite;
    }
    .marquee-content span { display: inline-block; padding-right: 50px; }
    
    @keyframes marquee {
        0% { transform: translateX(0); }
        100% { transform: translateX(-100%); }
    }

    /* Slider */
    .slider-container { width: 100%; height: 180px; margin-bottom: 30px; border-radius: var(--border-radius-large); overflow: hidden; position: relative; box-shadow: var(--soft-shadow); }
    .slider { display: flex; height: 100%; transition: transform 0.5s ease-in-out; }
    .slide { min-width: 100%; height: 100%; }
    .slide img { width: 100%; height: 100%; object-fit: cover; display: block; }

    /* Game Grid & Categories */
    .category-section { margin-bottom: 30px; }
    .section-title { font-size: 19px; font-weight: 700; margin: 0 0 20px 5px; letter-spacing: -0.5px; }
    .game-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 18px; padding-bottom: 10px;}
    
    /* Feature 2: Game Card with Relative Position for Badge */
    .game-card {
        background: var(--card-bg-color);
        border-radius: var(--border-radius-large);
        text-align: center;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: var(--soft-shadow);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 1px solid rgba(0,0,0,0.04);
        position: relative; /* For Badge Positioning */
    }
    
    /* MODIFIED: Feature 1 - Transparent Glass Badge with Animation */
    /* UPDATED: Badge moved to top-right corner flush to edges */
    .card-badge {
        position: absolute;
        top: 0; 
        right: 0;
        /* Transparent Background as requested */
        background-color: transparent;
        color: inherit;
        font-size: 16px; /* Slightly adjusted */
        font-weight: 700;
        padding: 4px 10px;
        min-width: 30px;
        height: auto;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5;
        overflow: hidden;
        white-space: nowrap;
        border-radius: 0 0 0 15px; /* Curve bottom-left only */
        text-shadow: 0 2px 5px rgba(0,0,0,0.15); /* Shadow to make text pop on transparent bg */
    }

    /* Glass Reflect Animation over the badge */
    .card-badge::after {
        content: '';
        position: absolute;
        top: 0;
        left: -150%;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        transform: skewX(-25deg);
        animation: glassReflect 2.5s infinite linear;
        filter: blur(3px);
    }

    @keyframes glassReflect {
        0% { left: -150%; }
        50% { left: 200%; }
        100% { left: 200%; }
    }

    body.dark-mode .game-card { border: 1px solid rgba(255,255,255,0.08); }
    .game-card:active { transform: scale(0.96); }
    
    .game-card .icon-wrapper {
        width: 100%; height: 160px; /* Increased from 130px */
        margin: 0 auto;
        background-color: var(--card-bg-color);
        display: flex; align-items: center; justify-content: center;
        padding: 10px; /* Reduced padding */
    }
    .game-card img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
    
    .game-card .game-info-container {
        padding: 12px;
        background-color: var(--card-bg-color);
        flex-grow: 1;
        display: flex; flex-direction: column; justify-content: center;
        border-top: 1px solid rgba(0,0,0,0.03);
    }
    .game-card .game-name { font-weight: 700; font-size: 15px; margin-bottom: 4px; }

    /* Topup Page & Forms */
    .page-header { display: flex; align-items: center; margin-bottom: 25px; padding-top: 10px;}
    .back-btn { font-size: 20px; cursor: pointer; margin-right: 15px; color: var(--primary-text-color); background: var(--card-bg-color); padding: 10px; border-radius: 50%; box-shadow: var(--soft-shadow); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;}
    .page-header h2 { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
    
    .game-banner { width: 100%; height: 160px; object-fit: cover; border-radius: var(--border-radius-large); margin-bottom: 25px; box-shadow: var(--soft-shadow); }
    .topup-section { background-color: var(--card-bg-color); border-radius: var(--border-radius-large); padding: 25px; margin-bottom: 25px; box-shadow: var(--soft-shadow); }
    
    .title { font-size: 16px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; }
    .step-number { background: var(--primary-purple); color: white; border-radius: 50%; width: 26px; height: 26px; display: inline-flex; justify-content: center; align-items: center; font-weight: 700; margin-right: 12px; font-size: 13px; box-shadow: 0 4px 10px rgba(123, 97, 255, 0.4); }
    
    .input-group label { display: block; margin-bottom: 10px; font-weight: 600; font-size: 14px; color: var(--secondary-text-color); margin-left: 2px;}
    
    /* MODIFIED: Copy Button Style */
    .copy-btn { margin-left: 10px; cursor: pointer; color: var(--primary-purple); background: rgba(123, 97, 255, 0.1); padding: 5px 10px; border-radius: 6px; font-size: 14px; transition: 0.2s;}
    .copy-btn:active { transform: scale(0.9); }

    .package-grid, .payment-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
    .package-item { background-color: var(--background-color); border: 2px solid transparent; border-radius: var(--border-radius-medium); padding: 20px 15px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
    
    /* Feature 4: Stock Out Style */
    .package-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background-color: rgba(0,0,0,0.05);
        border-color: rgba(0,0,0,0.1);
    }
    .stock-tag {
        font-size: 12px; color: var(--accent-red); font-weight: 700; display: block; margin-top: 4px; text-transform: uppercase;
    }

    .payment-item { 
        padding: 15px; min-height: 110px; 
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        gap: 8px; background-color: var(--background-color); 
        border: 2px solid transparent; border-radius: var(--border-radius-medium); 
        cursor: pointer; transition: all 0.2s;
    }
    .payment-item:active, .package-item:active { transform: scale(0.98); }
    .package-item.selected, .payment-item.selected { border-color: var(--primary-purple); background-color: rgba(123, 97, 255, 0.05); }
    .package-item.selected::after, .payment-item.selected::after {
        content: "\f00c"; font-family: "Font Awesome 6 Free"; font-weight: 900;
        position: absolute; top: 10px; right: 10px; color: var(--primary-purple); font-size: 12px;
    }
    
    .package-item .amount { font-weight: 700; font-size: 16px; text-align: center; margin-bottom: 5px; }
    .package-item .price { color: var(--primary-purple); font-weight: 700; font-size: 14px; text-align: center;}
    
    .payment-item img { max-height: 45px; width: auto; object-fit: contain; margin-bottom: 5px; }
    .payment-item span { font-size: 13px; font-weight: 600; color: var(--primary-text-color); }

    /* Feature 3: Quantity Selector CSS */
    .quantity-wrapper {
        display: flex; align-items: center; justify-content: center;
        background: var(--background-color);
        border-radius: var(--border-radius-medium);
        padding: 10px; width: 100%; margin-top: 15px;
    }
    .quantity-btn {
        width: 40px; height: 40px; border-radius: 10px;
        background: var(--card-bg-color); border: none;
        font-size: 18px; font-weight: bold; color: var(--primary-purple);
        cursor: pointer; box-shadow: var(--soft-shadow);
        display: flex; align-items: center; justify-content: center;
    }
    .quantity-input {
        width: 60px; text-align: center; font-size: 18px; font-weight: 700;
        background: transparent; border: none; color: var(--primary-text-color);
    }
    .quantity-input:focus { outline: none; }

    .wallet-balance-info { background-color: var(--light-purple); padding: 18px; border-radius: var(--border-radius-medium); margin-top: 15px; text-align: center; border: 1px solid rgba(123, 97, 255, 0.2); }
    .wallet-balance-info p { margin-bottom: 5px; font-size: 14px; color: var(--primary-text-color); }

    /* Profile & Wallet */
    .profile-card { text-align: center; margin-bottom: 30px; padding: 20px 0; }
    .profile-avatar-large { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; margin: 0 auto 15px; border: 4px solid var(--card-bg-color); box-shadow: var(--soft-shadow); }
    .profile-name { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 5px;}
    .profile-id { font-size: 14px; color: var(--secondary-text-color); font-weight: 500; background: var(--card-bg-color); padding: 5px 12px; border-radius: 20px; display: inline-block; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }

    .wallet-card { 
        background: linear-gradient(135deg, var(--primary-purple), #9f8eff); 
        color: white; padding: 35px; border-radius: var(--border-radius-large); 
        text-align: center; margin-bottom: 30px; position: relative; overflow: hidden;
        box-shadow: 0 10px 30px rgba(123, 97, 255, 0.3);
    }
    .wallet-card::before { content: ""; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; }
    .wallet-card p { font-size: 15px; opacity: 0.9; font-weight: 500; }
    .wallet-card h1 { font-size: 42px; margin: 10px 0 20px 0; font-weight: 800; letter-spacing: -1px; }
    .wallet-card .btn { background: white; color: var(--primary-purple); box-shadow: none; width: auto; padding: 12px 30px; border-radius: 30px; font-size: 14px; font-weight: 700; display: inline-block;}

    .profile-menu-item { display: flex; align-items: center; background-color: var(--card-bg-color); padding: 18px 20px; margin-bottom: 15px; border-radius: var(--border-radius-medium); cursor: pointer; box-shadow: var(--soft-shadow); transition: all 0.2s; }
    .profile-menu-item:active { transform: scale(0.98); }
    .profile-menu-item i { width: 35px; margin-right: 10px; text-align: center; font-size: 20px; color: var(--primary-purple); }
    .profile-menu-item span { font-weight: 600; font-size: 16px; }

    .details-card { background-color: var(--card-bg-color); border-radius: var(--border-radius-large); padding: 30px; text-align: center; box-shadow: var(--soft-shadow); }
    .details-card .icon { font-size: 60px; color: var(--accent-green); margin-bottom: 20px; }
    .details-card h2 { font-size: 26px; margin-bottom: 10px; font-weight: 800; }
    .details-card p { color: var(--secondary-text-color); margin-bottom: 30px; font-size: 15px; }
    .summary { text-align: left; background: var(--background-color); padding: 20px; border-radius: var(--border-radius-medium); }
    .summary-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
    body.dark-mode .summary-item { border-color: rgba(255,255,255,0.05); }
    .summary-item:last-child { border-bottom: none; }
    .summary-item span { color: var(--secondary-text-color); font-size: 14px; font-weight: 500; }
    .summary-item strong { color: var(--primary-text-color); font-size: 14px; font-weight: 600; }

    /* 2. Professional Bottom Nav */
    .bottom-nav {
        position: fixed; bottom: 0; left: 0; width: 100%;
        height: 80px;
        display: flex; justify-content: space-between; align-items: center;
        background-color: var(--card-bg-color);
        /* Modern backdrop blur */
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        background-color: rgba(255, 255, 255, 0.9);
        padding: 0 20px;
        box-shadow: var(--nav-shadow);
        z-index: 1000;
        border-top: 1px solid rgba(0,0,0,0.05);
        border-radius: 20px 20px 0 0;
    }
    body.dark-mode .bottom-nav { 
        background-color: rgba(28, 28, 30, 0.9); 
        border-color: rgba(255, 255, 255, 0.05); 
    }
    .nav-item { 
        cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: var(--secondary-text-color); position: relative; width: 60px;
        transition: color 0.3s;
    }
    .nav-item i { font-size: 22px; margin-bottom: 6px; transition: transform 0.2s; }
    .nav-item span { font-size: 11px; font-weight: 600; }
    .nav-item.active { color: var(--primary-purple); }
    .nav-item.active i { transform: translateY(-2px); }

    /* FIX 2: Notification Badge Styles */
    .nav-badge {
        position: absolute;
        top: 0; right: 15px;
        width: 10px; height: 10px;
        background-color: var(--accent-red);
        border-radius: 50%;
        border: 2px solid var(--card-bg-color);
        display: none; /* Hidden by default */
        z-index: 5;
    }
    
    /* Center Action Button */
    .nav-item-center { position: relative; top: -25px; }
    .nav-item-center .icon-bg { 
        width: 60px; height: 60px; 
        background: var(--primary-purple); 
        border-radius: 50%; 
        display: flex; align-items: center; justify-content: center; 
        box-shadow: 0 10px 25px rgba(123, 97, 255, 0.5); 
        border: 6px solid var(--background-color); 
        transition: transform 0.2s;
    }
    .nav-item-center:active .icon-bg { transform: scale(0.95); }
    .nav-item-center .icon-bg i { color: white; font-size: 24px; margin: 0; transform: none; }
    .nav-item-center span { margin-top: 5px; opacity: 0; visibility: hidden; } /* Hide label for center */
    /* Adjust badge for center item */
    .nav-item-center .nav-badge {
        top: 2px; right: 5px;
    }

    .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; color: white; }
    .status-Pending { background-color: #FF9500; }
    .status-Approved, .status-Completed { background-color: #34C759; }
    .status-Rejected, .status-Canceled { background-color: var(--accent-red); }

    .empty-state { text-align: center; padding: 60px 20px; color: var(--secondary-text-color); }
    .empty-state i { font-size: 55px; margin-bottom: 20px; display: block; color: var(--light-purple); }
    .empty-state p { font-size: 16px; font-weight: 500; }

    .theme-switch-container { display: flex; justify-content: space-between; align-items: center; }
    .theme-switch { position: relative; display: inline-block; width: 50px; height: 30px; }
    .theme-switch input { opacity: 0; width: 0; height: 0; }
    .slider-track { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #E9E9EA; transition: .4s; border-radius: 30px; }
    body.dark-mode .slider-track { background-color: #39393D; }
    .slider-track:before { position: absolute; content: ""; height: 26px; width: 26px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    input:checked + .slider-track { background-color: var(--primary-purple); }
    input:checked + .slider-track:before { transform: translateX(20px); }

    .support-fab {
        position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px;
        background-color: var(--primary-purple); color: white; border-radius: 50%;
        display: flex; align-items: center; justify-content: center; font-size: 24px;
        cursor: pointer; box-shadow: 0 8px 20px rgba(123, 97, 255, 0.4); z-index: 1001;
        transition: transform 0.2s;
    }
    .support-fab:active { transform: scale(0.9); }
    
    .modal {
        display: none; position: fixed; z-index: 1002; left: 0; top: 0; width: 100%; height: 100%;
        overflow: hidden; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
        justify-content: center; align-items: center;
    }
    .modal-content {
        background-color: var(--card-bg-color); padding: 25px; border-radius: var(--border-radius-large);
        width: 90%; max-width: 400px; box-shadow: var(--soft-shadow);
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    body.dark-mode .modal-header { border-color: rgba(255,255,255,0.05); }
    .modal-header h2 { font-size: 20px; font-weight: 700; }
    .close-btn { color: #8E8E93; font-size: 28px; font-weight: bold; cursor: pointer; }

    /* Support Chat */
    #supportModal .modal-content { display: flex; flex-direction: column; height: 75vh; }
    .support-chat-body { flex-grow: 1; overflow-y: auto; padding: 15px 0; }
    .support-chat-footer { display: flex; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 15px; }
    body.dark-mode .support-chat-footer { border-color: rgba(255,255,255,0.05); }
    #supportMessageInput { flex-grow: 1; border: none; background: var(--background-color); padding: 12px 15px; border-radius: 20px; color: var(--primary-text-color); font-size: 15px; margin-right: 10px;}
    #supportMessageInput:focus { outline: none; }
    #sendMessageBtn { background: var(--primary-purple); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(123, 97, 255, 0.3); }
    
    .message { padding: 10px 16px; border-radius: 18px; margin-bottom: 8px; max-width: 80%; word-wrap: break-word; font-size: 14px; line-height: 1.4; }
    .message.user { background-color: var(--primary-purple); color: white; align-self: flex-end; border-bottom-right-radius: 4px; margin-left: auto; }
    .message.admin { background-color: var(--background-color); color: var(--primary-text-color); align-self: flex-start; border-bottom-left-radius: 4px; }
    .message-container { display: flex; flex-direction: column; }

    /* Popup Modal */
    #dynamicPopup .modal-content { text-align: center; border-radius: var(--border-radius-large); }
    #popupImage { width: 100%; max-height: 220px; object-fit: cover; border-radius: var(--border-radius-medium); margin-top: 15px; display: none; }
    #popupMessage { margin-top: 20px; color: var(--secondary-text-color); font-size: 15px; line-height: 1.5; }
    /* FIX 3: Popup Button Style */
    .popup-btn {
        display: inline-block;
        margin-top: 15px;
        padding: 10px 20px;
        background-color: var(--primary-purple);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(123, 97, 255, 0.3);
        transition: transform 0.2s;
    }
    .popup-btn:active { transform: scale(0.96); }

    .status-indicator { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(0,0,0,0.05); }
    body.dark-mode .status-indicator { background: rgba(255,255,255,0.1); }
    .status-indicator.online { background-color: rgba(52, 199, 89, 0.15); color: #34C759; }
    .status-indicator.offline { background-color: rgba(255, 59, 48, 0.15); color: #FF3B30; }
    .status-indicator .dot { width: 8px; height: 8px; border-radius: 50%; }
    .status-indicator.online .dot { background-color: #34C759; }
    .status-indicator.offline .dot { background-color: #FF3B30; }
</style>
</head>
<body>
<div class="auth-container">
    <div class="screen active" id="loginScreen">
        <div class="auth-wrapper">
            <div class="auth-logo-container">
                <h1 id="authLogoText">Vercel Topup BD</h1>
            </div>
            <div class="auth-form">
                <h2>স্বাগতম</h2>
                <div class="input-group"> <input type="email" id="loginEmail" placeholder="আপনার ইমেইল"> </div>
                <div class="input-group"> <input type="password" id="loginPassword" placeholder="আপনার পাসওয়ার্ড"> </div>
                <button class="btn" onclick="handleLogin()">লগ ইন</button>
                <p class="form-link">অ্যাকাউন্ট নেই? <span onclick="toggleAuthScreens('signUpScreen')">সাইন আপ করুন</span></p>
            </div>
        </div>
    </div>
    <div class="screen" id="signUpScreen">
         <div class="auth-wrapper">
             <div class="auth-logo-container">
                <h1 id="authLogoTextSignUp">Vercel Topup BD</h1>
            </div>
            <div class="auth-form">
                <h2>নতুন অ্যাকাউন্ট</h2>
                <div class="input-group"> <input type="text" id="signUpName" placeholder="আপনার সম্পূর্ণ নাম"> </div>
                <div class="input-group"> <input type="email" id="signUpEmail" placeholder="আপনার ইমেইল"> </div>
                <div class="input-group"> <input type="password" id="signUpPassword" placeholder="নতুন পাসওয়ার্ড দিন"> </div>
                <button class="btn" onclick="handleSignUp()">সাইন আপ</button>
                <p class="form-link"> ইতোমধ্যে অ্যাকাউন্ট আছে? <span onclick="toggleAuthScreens('loginScreen')">লগইন করুন</span></p>
            </div>
        </div>
    </div>
</div>

<div class="app-container">
    <!-- Screen 1: Home Page -->
    <div class="screen active" id="homeScreen">
        <!-- Header -->
        <header class="header">
            <div class="header-brand">
                <img src="https://i.ibb.co/74CkxSP/avatar.png" alt="Logo" class="header-logo" id="headerAppLogo">
                <h1 class="header-title" id="headerAppName">Vercel Top Up</h1>
            </div>
            <div class="header-right-icons">
                 <div id="onlineStatus" class="status-indicator offline">
                    <span class="dot"></span>
                    <span id="onlineStatusText">Offline</span>
                </div>
                <img id="headerProfileAvatar" src="" alt="Avatar" class="profile-avatar" style="display: none;" onclick="showScreen('profileScreen', document.querySelectorAll('.nav-item')[4])">
            </div>
        </header>

        <!-- 3 & 4. Marquee Updated (Only here, animated CSS) -->
        <div class="marquee-wrapper">
            <div class="marquee-content">
                <span id="headerMarquee">আমাদের শপে আপনাকে স্বাগতম! সবচেয়ে কম দামে গেম টপ-আপ করুন।</span>
            </div>
        </div>

        <div class="slider-container">
            <div class="slider">
                <!-- Dynamic slider images will be loaded here -->
            </div>
        </div>
        
        <!-- NEW: Container for Categorized Game Sections -->
        <div id="homeCategoriesContainer">
            <!-- Dynamic Categories will be injected here (e.g., Games, Subscriptions) -->
        </div>
    </div>

    <!-- Screen 2: Top-Up Page -->
    <div class="screen" id="topupScreen">
        <header class="page-header"><i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('homeScreen', document.querySelector('.nav-item'))"></i><h2 id="gameTitle"></h2></header>
        <img id="gameBanner" src="" alt="Game Banner" class="game-banner">
        <div class="topup-section">
            <h3 class="title" id="inputStepTitle"><span class="step-number">1</span>আপনার প্লেয়ার আইডি দিন</h3>
            <div class="input-group"><input type="text" id="playerId" placeholder="এখানে প্লেয়ার আইডি লিখুন"></div>
        </div>
        <div class="topup-section">
            <h3 class="title"><span class="step-number">2</span>রিচার্জ অ্যামাউন্ট বেছে নিন</h3>
            <div class="package-grid" id="packageGrid"></div>
            <!-- Feature 3: Quantity Selector Injection Point -->
            <div id="quantityContainer"></div>
        </div>
        <div class="topup-section">
            <h3 class="title"><span class="step-number">3</span>পেমেন্ট মেথড বেছে নিন</h3>
            <div class="payment-grid" id="topupPaymentGrid">
                <!-- Payment methods will be loaded here dynamically -->
            </div>
             <div id="paymentDetailsSection" style="display: none; margin-top: 20px;">
                <!-- Payment input fields will be injected here -->
            </div>
        </div>
        
        <!-- NEW: Description Box Section -->
        <div class="topup-section" id="gameDescriptionContainer" style="display:none;">
            <h3 class="title">বিস্তারিত নিয়মাবলী</h3>
            <p id="gameDescriptionText" style="font-size: 14px; color: var(--secondary-text-color); line-height: 1.6; white-space: pre-wrap;"></p>
        </div>

        <button class="btn" onclick="processOrder()">এখুনি কিনুন</button>
    </div>

    <!-- Screen 3: Wallet Screen -->
    <div class="screen" id="walletScreen">
        <header class="page-header"><h2 style="margin: auto;">আমার ওয়ালেট</h2></header>
        <div class="wallet-card">
            <p>আপনার বর্তমান ব্যালেন্স</p>
            <h1 id="profileWalletBalance">৳ 0.00</h1>
             <button class="btn" onclick="showScreen('addMoneyScreen', document.querySelectorAll('.nav-item')[2])">অ্যাড মানি</button>
        </div>
        <div class="topup-section">
            <h3 class="title">মানি রিকোয়েস্ট হিস্টোরি</h3>
            <div id="moneyRequestHistory"></div>
        </div>
    </div>

    <!-- Screen 4: Add Money Screen -->
    <div class="screen" id="addMoneyScreen">
         <header class="page-header"><i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('walletScreen', document.querySelectorAll('.nav-item')[1])"></i><h2>অ্যাড মানি</h2></header>
         <div class="topup-section">
            <h3 class="title"><span class="step-number">1</span>অ্যামাউন্ট লিখুন</h3>
            <div class="input-group"> <input type="number" id="addMoneyAmount" placeholder="e.g., 500"> </div>
        </div>
        <div class="topup-section">
            <h3 class="title"><span class="step-number">2</span>পেমেন্ট মেথড বেছে নিন</h3>
            <div class="payment-grid" id="addMoneyPaymentGrid">
                <!-- Add Money payment methods will be loaded here dynamically -->
            </div>
             <div id="addMoneyPaymentDetailsSection" style="display: none; margin-top: 20px;">
                <p style="text-align: center; font-weight: 600; margin-bottom: 10px;">
                    নিচের নম্বরে টাকা পাঠান: <br>
                    <strong id="addMoneyAdminPaymentNumber" style="color: var(--primary-purple); font-size: 18px;"></strong>
                    <!-- MODIFIED: Add Money Copy Button -->
                    <i class="fa-regular fa-copy copy-btn" onclick="copyToClipboard(document.getElementById('addMoneyAdminPaymentNumber').innerText)"></i>
                </p>
                <div class="input-group" style="margin-top: 15px;">
                    <label for="addMoneyUserPaymentNumber">আপনার পেমেন্ট নম্বর</label>
                    <input type="tel" id="addMoneyUserPaymentNumber" placeholder="যে নম্বর থেকে টাকা পাঠিয়েছেন">
                </div>
                <div class="input-group">
                    <label for="addMoneyTransactionId">ট্রানজেকশন আইডি</label>
                    <input type="text" id="addMoneyTransactionId" placeholder="টাকা পাঠানোর পর প্রাপ্ত আইডি">
                </div>
            </div>
        </div>
        <button class="btn" onclick="processAddMoneyRequest()">রিকোয়েস্ট করুন</button>
    </div>

    <!-- Screen 5: Profile Page -->
    <div class="screen" id="profileScreen">
        <header class="page-header"><h2 style="margin: auto;">প্রোফাইল</h2></header>
        <div class="profile-card">
            <img id="profileScreenAvatar" src="https://i.ibb.co/74CkxSP/avatar.png" alt="User Avatar" class="profile-avatar-large">
            <h3 class="profile-name" id="profileNameDisplay"></h3>
            <p class="profile-id" id="profileIdDisplay"></p>
        </div>

        <div class="profile-menu">
            <div class="profile-menu-item" onclick="showScreen('walletScreen', document.querySelectorAll('.nav-item')[1])"><i class="fa-solid fa-wallet"></i><span>ওয়ালেট</span></div>
            <div class="profile-menu-item" onclick="showOrderHistoryScreen(document.querySelectorAll('.nav-item')[3])"><i class="fa-solid fa-receipt"></i><span>অর্ডার হিস্টোরি</span></div>
            <div class="profile-menu-item" onclick="toggleSettings()"><i class="fa-solid fa-cogs"></i><span>সেটিংস</span></div>
            <div class="profile-menu-item" onclick="handleLogout()"><i class="fa-solid fa-right-from-bracket"></i><span>লগ আউট</span></div>
        </div>
        
        <div id="settingsSection" style="display: none; margin-top: 15px;">
            <div class="topup-section">
                <h3 class="title">থিম পরিবর্তন করুন</h3>
                <div class="theme-switch-container">
                    <span>ডার্ক মোড</span>
                    <label class="theme-switch">
                        <input type="checkbox" id="theme-toggle">
                        <span class="slider-track"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

     <!-- Screen 6: Order History -->
    <div class="screen" id="orderHistoryScreen">
        <header class="page-header"><h2 style="margin: auto;">মাই অর্ডার</h2></header>
        <div id="orderHistoryContainer"></div>
    </div>

    <!-- Screen 7: Order Details Success Page -->
    <div class="screen" id="orderDetailsScreen">
         <header class="page-header"><i class="fa-solid fa-arrow-left back-btn" onclick="showOrderHistoryScreen(document.querySelectorAll('.nav-item')[3])"></i><h2>অর্ডার সম্পন্ন হয়েছে</h2></header>
         <div id="orderDetailsContainer"></div>
    </div>

    <!-- Screen 8: Money Request Success Page -->
    <div class="screen" id="moneyRequestSuccessScreen">
        <header class="page-header"><i class="fa-solid fa-arrow-left back-btn" onclick="showScreen('walletScreen', document.querySelectorAll('.nav-item')[1])"></i><h2>রিকোয়েস্ট পাঠানো হয়েছে</h2></header>
        <div id="moneyRequestSuccessContainer"></div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="showScreen('homeScreen', this)"> <i class="fa-solid fa-house"></i> <span>হোম</span> </div>
        <div class="nav-item" onclick="showScreen('walletScreen', this)"> <i class="fa-solid fa-wallet"></i> <span>ওয়ালেট</span> </div>
        <!-- Add Money Badge -->
        <div class="nav-item nav-item-center" onclick="showScreen('addMoneyScreen', this)"> 
            <div class="icon-bg">
                <i class="fa-solid fa-plus"></i>
                <span class="nav-badge" id="addMoneyBadge"></span>
            </div> 
            <span>অ্যাড</span> 
        </div>
        <!-- Order History Badge -->
        <div class="nav-item" onclick="showOrderHistoryScreen(this)"> 
            <i class="fa-solid fa-receipt"></i> 
            <span class="nav-badge" id="orderBadge"></span>
            <span>অর্ডার</span> 
        </div>
        <div class="nav-item" onclick="showScreen('profileScreen', this)"> <i class="fa-regular fa-user"></i> <span>প্রোফাইল</span> </div>
    </nav>
    
    <div class="support-fab" id="supportBtn"><i class="fa-solid fa-headset"></i></div>

    <!-- Support Chat Modal -->
    <div id="supportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>সাপোর্ট চ্যাট</h2>
                <span class="close-btn" id="supportCloseBtn">&times;</span>
            </div>
            <div class="support-chat-body" id="supportChatBody">
                <!-- Messages will be loaded here -->
            </div>
            <div class="support-chat-footer">
                <input type="text" id="supportMessageInput" placeholder="আপনার মেসেজ লিখুন...">
                <button id="sendMessageBtn"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- Dynamic Popup Modal -->
    <div id="dynamicPopup" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="popupTitle"></h2>
                <span class="close-btn" id="popupCloseBtn">&times;</span>
            </div>
            <img id="popupImage" src="" alt="Popup Image">
            <p id="popupMessage"></p>
            <!-- FIX 3: Added Action Button -->
            <a id="popupActionButton" class="popup-btn" style="display: none;" href="#" target="_blank">Tap Here</a>
        </div>
    </div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCZrkWD_5YQW0P-3SYhAzSE4pbCyTqvYu8",
      authDomain: "topupshopnur.firebaseapp.com",
      projectId: "topupshopnur",
      storageBucket: "topupshopnur.firebasestorage.app",
      messagingSenderId: "25262245834",
      appId: "1:25262245834:web:5a867f0516b120bfbcb133",
      measurementId: "G-QR5PYZDCG8"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    let currentUser = null;
    let selectedGameData = {}, selectedPackage = null, selectedPayment = null, selectedAddMoneyPayment = null;
    let currentQuantity = 1; // Feature 3: Track Quantity
    let gamesFromDB = [];
    let paymentMethodsFromDB = [];
    const authContainer = document.querySelector('.auth-container');
    const appContainer = document.querySelector('.app-container');
    const EDIT_WINDOW_MS = 3 * 60 * 1000; 

    const themeToggle = document.getElementById('theme-toggle');
    const currentTheme = localStorage.getItem('theme');

    if (currentTheme) {
        document.body.classList.add(currentTheme);
        if (currentTheme === 'dark-mode') {
            themeToggle.checked = true;
        }
    }

    themeToggle.addEventListener('change', () => {
        if (themeToggle.checked) {
            document.body.classList.add('dark-mode');
            localStorage.setItem('theme', 'dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('theme', 'light-mode');
        }
    });

    function toggleSettings() {
        const settingsSection = document.getElementById('settingsSection');
        settingsSection.style.display = settingsSection.style.display === 'none' ? 'block' : 'none';
    }
    
    // MODIFIED: Helper function to copy text
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('নম্বর কপি করা হয়েছে: ' + text);
        }).catch(err => {
            console.error('Copy failed', err);
        });
    }

    loadBranding();

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            currentUser = user;
            db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    updateProfileDisplay(data.name, data.profileId, data.photoURL);
                    updateWalletDisplay(data.walletBalance);
                }
            });

            await loadGamesFromFirestore();
            await loadPaymentMethods();

            authContainer.style.display = 'none';
            appContainer.style.display = 'block';

            initializeAddMoneyScreen();
            loadMoneyRequestHistory();
            loadOrderHistory();
            loadSlider();
            initializeNoticeListener();
            initializeOnlineStatusListener();
            initializePopupListener();
        } else {
            currentUser = null;
            authContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        }
    });

    async function loadPaymentMethods() {
        try {
            const snapshot = await db.collection('paymentMethods').get();
            paymentMethodsFromDB = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            populatePaymentGrids();
        } catch (error) {
            console.error("Error fetching payment methods: ", error);
        }
    }
    
    function populatePaymentGrids() {
        const topupGrid = document.getElementById('topupPaymentGrid');
        const addMoneyGrid = document.getElementById('addMoneyPaymentGrid');
        topupGrid.innerHTML = '';
        addMoneyGrid.innerHTML = '';

        const walletOptionHtml = `
            <div class="payment-item" data-payment-id="wallet" data-type="wallet">
                <i class="fa-solid fa-wallet" style="font-size: 24px; color: var(--primary-purple); margin-bottom: 5px;"></i>
                <span>My Wallet</span>
            </div>`;
        topupGrid.innerHTML += walletOptionHtml;

        paymentMethodsFromDB.forEach(method => {
            const itemHtml = `<div class="payment-item" data-payment-id="${method.id}" data-type="manual">
                                <img src="${method.logoUrl}" alt="${method.name}">
                                <span>${method.name}</span>
                              </div>`;
            topupGrid.innerHTML += itemHtml; 
            addMoneyGrid.innerHTML += itemHtml; 
        });
        
        initializePaymentSelection();
    }

    function initializePaymentSelection() {
        document.querySelectorAll('#topupPaymentGrid .payment-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('#topupPaymentGrid .payment-item.selected').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
                
                const type = item.getAttribute('data-type');
                const detailsSection = document.getElementById('paymentDetailsSection');
                detailsSection.innerHTML = ''; 
                detailsSection.style.display = 'block';

                // Feature 3: Calculate total price for display
                const totalPrice = selectedPackage ? (parseFloat(selectedPackage.price) * currentQuantity).toFixed(2) : 0;

                if (type === 'wallet') {
                    selectedPayment = { name: 'Wallet', type: 'wallet' };
                    detailsSection.innerHTML = `
                        <div class="wallet-balance-info">
                            <p>মোট মূল্য: <strong id="displayPackagePrice">৳ ${totalPrice}</strong></p>
                            <p>আপনার ওয়ালেট থেকে টাকা কাটা হবে।</p>
                        </div>
                    `;
                } else {
                    const selectedMethodId = item.dataset.paymentId;
                    const method = paymentMethodsFromDB.find(m => m.id === selectedMethodId);
                    selectedPayment = { ...method, type: 'manual' };

                    // MODIFIED: Added Copy Button for Topup Payment
                    detailsSection.innerHTML = `
                        <p style="text-align: center; font-weight: 600; margin-bottom: 10px;">
                            নিচের নম্বরে টাকা পাঠান: <br>
                            <span style="color: var(--primary-purple); font-size: 18px;">${method.number}</span>
                            <i class="fa-regular fa-copy copy-btn" onclick="copyToClipboard('${method.number}')"></i>
                        </p>
                         <p style="text-align:center; margin-bottom: 10px; font-size: 14px;">মোট টাকার পরিমাণ: <strong id="displayPackagePrice">৳ ${totalPrice}</strong></p>
                        <div class="input-group" style="margin-top: 15px;">
                            <label for="userPaymentNumber">আপনার পেমেন্ট নম্বর</label>
                            <input type="tel" id="userPaymentNumber" placeholder="যে নম্বর থেকে টাকা পাঠিয়েছেন">
                        </div>
                        <div class="input-group">
                            <label for="transactionId">ট্রানজেকশন আইডি</label>
                            <input type="text" id="transactionId" placeholder="টাকা পাঠানোর পর প্রাপ্ত আইডি">
                        </div>
                    `;
                }
            });
        });

        document.querySelectorAll('#addMoneyPaymentGrid .payment-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('#addMoneyPaymentGrid .payment-item.selected').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
                const selectedMethodId = item.dataset.paymentId;
                const method = paymentMethodsFromDB.find(m => m.id === selectedMethodId);
                if (method) {
                    selectedAddMoneyPayment = method;
                    document.getElementById('addMoneyPaymentDetailsSection').style.display = 'block';
                    document.getElementById('addMoneyAdminPaymentNumber').innerText = method.number;
                }
            });
        });
    }


    async function loadBranding() {
        try {
            const doc = await db.collection('settings').doc('branding').get();
            if (!doc.exists) return;

            const { appName, profileIconUrl } = doc.data();

            const ids = ['', 'SignUp'];
            ids.forEach(id => {
                const logoText = document.getElementById(`authLogoText${id}`);
                if (appName && logoText) { 
                    logoText.innerText = appName;
                }
            });
            
            const headerAppName = document.getElementById('headerAppName');
            const headerAppLogo = document.getElementById('headerAppLogo');
            
            if (appName && headerAppName) headerAppName.innerText = appName;
            
            if (profileIconUrl && headerAppLogo) {
                headerAppLogo.src = profileIconUrl;
            }

        } catch (error) {
            console.error("Error loading branding:", error);
        }
    }
    
    function updateProfileDisplay(name, id, photoURL) {
        document.getElementById('profileNameDisplay').innerText = name;
        document.getElementById('profileIdDisplay').innerText = `ID: ${id}`;
        
        const profileScreenAvatar = document.getElementById('profileScreenAvatar');
        const headerProfileAvatar = document.getElementById('headerProfileAvatar');
        
        const avatarUrl = photoURL || "https://i.ibb.co/74CkxSP/avatar.png";
        profileScreenAvatar.src = avatarUrl;
        
        if(headerProfileAvatar) {
            headerProfileAvatar.src = avatarUrl;
            headerProfileAvatar.style.display = 'block';
        }
    }
    
    function initializeNoticeListener() {
        const marquee = document.getElementById('headerMarquee');
        db.collection('settings').doc('notice').onSnapshot(doc => {
            if (doc.exists && doc.data().text) {
                const text = doc.data().text;
                if(marquee) marquee.innerText = text;
            }
        });
    }

    async function handleSignUp() {
        const name = document.getElementById('signUpName').value;
        const email = document.getElementById('signUpEmail').value;
        const password = document.getElementById('signUpPassword').value;
        if (!name || !email || !password) { alert('অনুগ্রহ করে সকল তথ্য পূরণ করুন।'); return; }

        try {
            const avatarSettingsDoc = await db.collection('settings').doc('defaultAvatars').get();
            const defaultMaleAvatar = avatarSettingsDoc.data()?.maleAvatarUrl || "https://i.ibb.co/74CkxSP/avatar.png";
            const defaultFemaleAvatar = avatarSettingsDoc.data()?.femaleAvatarUrl || "https://i.ibb.co/74CkxSP/avatar.png";

            let assignedAvatarUrl = defaultMaleAvatar;
            const lowerCaseName = name.toLowerCase();
            const femaleIdentifiers = ['a', 'i', 'akter', 'begum', 'fatima', 'jannat', 'tasnim', 'nisa', 'khatun'];
            
            if (femaleIdentifiers.some(identifier => lowerCaseName.includes(identifier))) {
                assignedAvatarUrl = defaultFemaleAvatar;
            }

            const userCredential = await auth.createUserWithEmailAndPassword(email, password);
            const user = userCredential.user;

            await db.collection('users').doc(user.uid).set({
                name: name,
                email: email,
                profileId: `GS-${Math.random().toString(36).substr(2, 6).toUpperCase()}`,
                walletBalance: 0,
                status: 'active',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                photoURL: assignedAvatarUrl 
            });

        } catch (error) { 
            alert('সাইন আপ করতে সমস্যা হয়েছে: ' + error.message); 
        }
    }

    async function handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        if (!email || !password) { alert('অনুগ্রহ করে ইমেইল ও পাসওয়ার্ড দিন।'); return; }

        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const userDoc = await db.collection('users').doc(userCredential.user.uid).get();

            if (userDoc.exists && userDoc.data().status === 'blocked') {
                await auth.signOut();
                alert('আপনার অ্যাকাউন্টটি ব্লক করা হয়েছে। অনুগ্রহ করে সাপোর্টে যোগাযোগ করুন।');
            }
        } catch (error) {
            alert('লগইন করতে সমস্যা হয়েছে: ' + error.message);
        }
    }

    function handleLogout() { auth.signOut(); }

    function toggleAuthScreens(screenId) {
        document.querySelectorAll('.auth-container .screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    }

    async function processAddMoneyRequest() {
        const amount = parseFloat(document.getElementById('addMoneyAmount').value);
        const userPaymentNumber = document.getElementById('addMoneyUserPaymentNumber').value;
        const transactionId = document.getElementById('addMoneyTransactionId').value;

        if (isNaN(amount) || amount <= 0 || !selectedAddMoneyPayment || !userPaymentNumber || !transactionId) {
            alert('অনুগ্রহ করে সকল তথ্য সঠিকভাবে পূরণ করুন।');
            return;
        }

        const requestData = {
            userId: currentUser.uid,
            amount: amount,
            paymentMethod: selectedAddMoneyPayment.name,
            adminNumber: selectedAddMoneyPayment.number,
            userPaymentNumber: userPaymentNumber,
            transactionId: transactionId,
            status: 'Pending',
            date: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await db.collection('moneyRequests').add(requestData);
            showMoneyRequestSuccess(requestData);
        } catch (error) {
            alert("রিকোয়েস্ট করতে সমস্যা হয়েছে: " + error.message);
        }
    }

    function loadMoneyRequestHistory() {
        const container = document.getElementById('moneyRequestHistory');
        const badge = document.getElementById('addMoneyBadge'); // FIX 2
        if (!container || !currentUser) return;

        db.collection('moneyRequests').where('userId', '==', currentUser.uid)
        .onSnapshot(querySnapshot => {
            if (querySnapshot.empty) {
                container.innerHTML = `<div class="empty-state"><i class="fa-solid fa-file-invoice-dollar"></i><p>কোনো রিকোয়েস্ট খুঁজে পাওয়া যায়নি।</p></div>`;
                if(badge) badge.style.display = 'none'; // No badge
                return;
            }

            let requests = [];
            let pendingCount = 0; // FIX 2: Count pending
            querySnapshot.forEach(doc => {
                const data = doc.data();
                requests.push({ id: doc.id, ...data });
                if(data.status === 'Pending') pendingCount++;
            });
            
            // FIX 2: Toggle Badge
            if(badge) badge.style.display = pendingCount > 0 ? 'block' : 'none';

            requests.sort((a, b) => {
                 const dateA = a.date ? a.date.seconds : 0;
                 const dateB = b.date ? b.date.seconds : 0;
                 return dateB - dateA;
            });

            let historyHtml = '';
            requests.forEach(request => {
                const requestId = request.id;
                const requestDate = request.date ? request.date.toDate() : new Date();
                const isEditable = (new Date() - requestDate) < EDIT_WINDOW_MS && request.status === 'Pending';

                let buttons = '';
                if (request.status === 'Pending') {
                    buttons = `<div class="action-buttons">
                            ${isEditable ? `<button class="btn btn-secondary" onclick="editMoneyRequest('${requestId}')">এডিট</button>` : ''}
                            <button class="btn btn-danger" onclick="cancelMoneyRequest('${requestId}')">মুছে ফেলুন</button>
                        </div>`;
                }

                historyHtml += `<div class="topup-section" style="margin-bottom: 10px;">
                    <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom: 8px;">
                        <span>৳ ${request.amount}</span>
                        <span class="status-badge status-${request.status}">${request.status}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom: 8px;"><span>পেমেন্ট:</span><strong>${request.paymentMethod}</strong></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom: 8px;"><span>নম্বর:</span><strong>${request.userPaymentNumber}</strong></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom: 8px;"><span>ট্রানজেকশন আইডি:</span><strong>${request.transactionId}</strong></div>
                    <div style="display:flex; justify-content:space-between;"><span>তারিখ:</span><strong>${requestDate.toLocaleString('bn-BD')}</strong></div>
                    ${buttons}
                </div>`;
            });
            container.innerHTML = historyHtml;
        }, error => {
            console.error("Error loading money request history: ", error);
            if (error.code !== 'failed-precondition') {
                 container.innerHTML = `<div class="empty-state"><i class="fa-solid fa-circle-exclamation"></i><p>হিস্ট্রি লোড করা যায়নি।</p></div>`;
            }
        });
    }

    async function processOrder() {
        const playerId = document.getElementById('playerId').value;
        
        if (!playerId) { alert('দয়া করে আইডি/ইমেইল দিন।'); return; }
        if (!selectedPackage) { alert('দয়া করে একটি প্যাকেজ সিলেক্ট করুন।'); return; }
        if (!selectedPayment) { alert('দয়া করে পেমেন্ট মেথড সিলেক্ট করুন।'); return; }

        // Feature 3: Calculate Total Price based on Quantity
        const packagePrice = parseFloat(selectedPackage.price);
        const totalPrice = packagePrice * currentQuantity;

        let orderData = {
            userId: currentUser.uid,
            game: selectedGameData.name,
            package: selectedPackage.amount,
            quantity: currentQuantity, // Send quantity
            price: totalPrice, // Send total price
            playerId: playerId,
            paymentMethod: selectedPayment.name,
            status: 'Pending',
            date: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if (selectedPayment.type === 'wallet') {
                const userRef = db.collection('users').doc(currentUser.uid);

                await db.runTransaction(async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists) { throw "User does not exist!"; }

                    const userData = userDoc.data();
                    const currentBalance = parseFloat(userData.walletBalance) || 0;

                    if (currentBalance < totalPrice) {
                        throw "আপনার ওয়ালেটে পর্যাপ্ত ব্যালেন্স নেই। দয়া করে 'Add Money' করুন।";
                    }

                    const newBalance = currentBalance - totalPrice;
                    transaction.update(userRef, { walletBalance: newBalance });

                    const newOrderRef = db.collection('orders').doc();
                    orderData.transactionId = 'WALLET_PAY';
                    orderData.userPaymentNumber = 'N/A';
                    orderData.adminNumber = 'N/A';
                    
                    transaction.set(newOrderRef, orderData);
                });

                alert('অর্ডার সফল হয়েছে! ওয়ালেট থেকে টাকা কাটা হয়েছে।');
                showOrderDetails(orderData);

            } else {
                const userPaymentNumber = document.getElementById('userPaymentNumber').value;
                const transactionId = document.getElementById('transactionId').value;

                if (!userPaymentNumber || !transactionId) {
                    alert('দয়া করে পেমেন্ট নম্বর এবং ট্রানজেকশন আইডি দিন।'); return;
                }

                orderData.adminNumber = selectedPayment.number;
                orderData.userPaymentNumber = userPaymentNumber;
                orderData.transactionId = transactionId;

                await db.collection('orders').add(orderData);
                showOrderDetails(orderData);
            }

        } catch (error) {
            if (typeof error === 'string') {
                alert(error);
            } else {
                console.error(error);
                alert("অর্ডার করতে সমস্যা হয়েছে: " + error.message);
            }
        }
    }

    function loadOrderHistory() {
        const container = document.getElementById('orderHistoryContainer');
        const badge = document.getElementById('orderBadge'); // FIX 2
        if (!container || !currentUser) return;

        db.collection('orders').where('userId', '==', currentUser.uid)
        .onSnapshot(querySnapshot => {
            if (querySnapshot.empty) {
                container.innerHTML = `<div class="empty-state"><i class="fa-solid fa-receipt"></i><p>কোনো অর্ডার পাওয়া যায়নি।</p></div>`;
                if(badge) badge.style.display = 'none'; // No badge
                return;
            }

            let orders = [];
            let pendingCount = 0; // FIX 2
            querySnapshot.forEach(doc => {
                const data = doc.data();
                orders.push({ id: doc.id, ...data });
                if(data.status === 'Pending') pendingCount++;
            });

            // FIX 2: Toggle Badge
            if(badge) badge.style.display = pendingCount > 0 ? 'block' : 'none';
            
            orders.sort((a, b) => {
                 const dateA = a.date ? a.date.seconds : 0;
                 const dateB = b.date ? b.date.seconds : 0;
                 return dateB - dateA;
            });

            let historyHtml = '';
            orders.forEach(order => {
                const orderId = order.id;
                const orderDate = order.date ? order.date.toDate() : new Date();
                const isEditable = (new Date() - orderDate) < EDIT_WINDOW_MS && order.status === 'Pending';
                
                // Show Quantity in History
                const quantityText = order.quantity ? ` x ${order.quantity}` : '';

                let buttons = '';
                if (order.status === 'Pending') {
                    buttons = `<div class="action-buttons">
                            ${isEditable ? `<button class="btn btn-secondary" onclick="editOrder('${orderId}')">এডিট</button>` : ''}
                            <button class="btn btn-danger" onclick="cancelOrder('${orderId}')">মুছে ফেলুন</button>
                        </div>`;
                }

                historyHtml += `<div class="topup-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                        <span>গেম: <strong>${order.game}</strong></span>
                        <span class="status-badge status-${order.status}">${order.status}</span>
                    </div>
                    <p style="display:flex; justify-content:space-between; margin-bottom: 8px;"><span>প্যাকেজ:</span><strong>${order.package}${quantityText}</strong></p>
                    <p style="display:flex; justify-content:space-between; margin-bottom: 8px;"><span>প্লেয়ার আইডি:</span><strong>${order.playerId}</strong></p>
                     <p style="display:flex; justify-content:space-between; margin-bottom: 8px;"><span>ট্রানজেকশন আইডি:</span><strong>${order.transactionId || 'N/A'}</strong></p>
                    <p style="display:flex; justify-content:space-between;"><span>তারিখ:</span><strong>${orderDate.toLocaleString('bn-BD')}</strong></p>
                    ${buttons}
                </div>`;
            });
             container.innerHTML = historyHtml;
        }, error => {
            console.error("Error loading order history: ", error);
            if (error.code !== 'failed-precondition') {
                container.innerHTML = `<div class="empty-state"><i class="fa-solid fa-circle-exclamation"></i><p>হিস্ট্রি লোড করা যায়নি।</p></div>`;
            }
        });
    }

    async function cancelOrder(orderId) {
        if (!confirm('আপনি কি নিশ্চিতভাবে এই অর্ডারটি মুছে ফেলতে চান? যদি ওয়ালেট দিয়ে পেমেন্ট করে থাকেন, তবে টাকা ফেরত দেওয়া হবে।')) {
            return;
        }

        try {
            await db.runTransaction(async (transaction) => {
                const orderRef = db.collection('orders').doc(orderId);
                const orderDoc = await transaction.get(orderRef);

                if (!orderDoc.exists) {
                    throw "অর্ডারটি পাওয়া যায়নি।";
                }

                const orderData = orderDoc.data();

                if (orderData.status !== 'Pending') {
                    throw "এই অর্ডারটি এখন আর ক্যানসেল করা যাবে না।";
                }

                if (orderData.transactionId === 'WALLET_PAY' || orderData.paymentMethod === 'Wallet') {
                    const userRef = db.collection('users').doc(orderData.userId);
                    const userDoc = await transaction.get(userRef);

                    if (userDoc.exists) {
                        const currentBalance = parseFloat(userDoc.data().walletBalance) || 0;
                        const refundAmount = parseFloat(orderData.price);
                        
                        transaction.update(userRef, { 
                            walletBalance: currentBalance + refundAmount 
                        });
                    }
                }

                transaction.delete(orderRef);
            });

            alert('অর্ডারটি সফলভাবে বাতিল করা হয়েছে এবং প্রযোজ্য ক্ষেত্রে ওয়ালেটে টাকা ফেরত দেওয়া হয়েছে।');

        } catch (error) {
            console.error("Cancellation Error: ", error);
            alert('সমস্যা হয়েছে: ' + (error.message || error));
        }
    }

    async function editOrder(orderId) {
        try {
            const doc = await db.collection('orders').doc(orderId).get();
            if (!doc.exists) { alert('অর্ডার পাওয়া যায়নি!'); return; }
            const order = doc.data();
            const newPlayerId = prompt('আপনার নতুন প্লেয়ার আইডি দিন:', order.playerId);
            const newTransactionId = prompt('নতুন ট্রানজেকশন আইডি দিন:', order.transactionId);

            const updates = {};
             if (newPlayerId && newPlayerId.trim() !== '' && newPlayerId !== order.playerId) {
                updates.playerId = newPlayerId;
            }
            if (newTransactionId && newTransactionId.trim() !== '' && newTransactionId !== order.transactionId) {
                updates.transactionId = newTransactionId;
            }
            if (Object.keys(updates).length > 0) {
                await db.collection('orders').doc(orderId).update(updates);
                alert('অর্ডার সফলভাবে আপডেট করা হয়েছে!');
            }
        } catch (e) { alert('আপডেট করতে সমস্যা হয়েছে: ' + e.message); }
    }

    function cancelMoneyRequest(requestId) {
        if (confirm('আপনি কি নিশ্চিতভাবে এই রিকোয়েস্টটি মুছে ফেলতে চান?')) {
            db.collection('moneyRequests').doc(requestId).delete()
              .then(() => alert('রিকোয়েস্টটি সফলভাবে মুছে ফেলা হয়েছে।'))
              .catch(e => alert('সমস্যা হয়েছে: ' + e.message));
        }
    }

    async function editMoneyRequest(requestId) {
        try {
            const doc = await db.collection('moneyRequests').doc(requestId).get();
            if (!doc.exists) { alert('রিকোয়েস্ট পাওয়া যায়নি!'); return; }
            const request = doc.data();
            const newAmount = prompt('নতুন অ্যামাউন্ট লিখুন:', request.amount);
            const newNumber = prompt('নতুন পেমেন্ট নম্বর দিন:', request.userPaymentNumber);
            const newTransactionId = prompt('নতুন ট্রানজেকশন আইডি দিন:', request.transactionId);

            const updates = {};
            if (newAmount && parseFloat(newAmount) > 0 && parseFloat(newAmount) !== request.amount) {
                updates.amount = parseFloat(newAmount);
            }
            if (newNumber && newNumber.trim() !== '' && newNumber !== request.userPaymentNumber) {
                updates.userPaymentNumber = newNumber;
            }
             if (newTransactionId && newTransactionId.trim() !== '' && newTransactionId !== request.transactionId) {
                updates.transactionId = newTransactionId;
            }
            if (Object.keys(updates).length > 0) {
                await db.collection('moneyRequests').doc(requestId).update(updates);
                alert('রিকোয়েস্ট সফলভাবে আপডেট করা হয়েছে!');
            }
        } catch (e) { alert('আপডেট করতে সমস্যা হয়েছে: ' + e.message); }
    }

    function showScreen(screenId, navElement) {
        document.querySelectorAll('.app-container .screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        if (navElement) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            navElement.classList.add('active');
        }
    }

    function updateWalletDisplay(balance) {
        const formattedBalance = `৳ ${parseFloat(balance || 0).toFixed(2)}`;
        document.getElementById('profileWalletBalance').innerText = formattedBalance;
    }

    function showOrderHistoryScreen(navElement) { showScreen('orderHistoryScreen', navElement); }

    function showOrderDetails(orderData) {
        const container = document.getElementById('orderDetailsContainer');
        container.innerHTML = `<div class="details-card">
                <div class="icon"><i class="fa-solid fa-check-circle"></i></div>
                <h2>অর্ডারটি সফল হয়েছে!</h2>
                <p>আপনার অর্ডারটি প্রক্রিয়া করা হচ্ছে। বিস্তারিত নিচে দেখুন।</p>
                <div class="summary">
                    <div class="summary-item"><span>গেম:</span><strong>${orderData.game}</strong></div>
                    <div class="summary-item"><span>প্যাকেজ:</span><strong>${orderData.package} (x${orderData.quantity || 1})</strong></div>
                    <div class="summary-item"><span>প্লেয়ার আইডি:</span><strong>${orderData.playerId}</strong></div>
                    <div class="summary-item"><span>মোট মূল্য:</span><strong>৳ ${orderData.price.toFixed(2)}</strong></div>
                </div>
            </div>`;
        showScreen('orderDetailsScreen');
    }

    function showMoneyRequestSuccess(requestData) {
        const container = document.getElementById('moneyRequestSuccessContainer');
        container.innerHTML = `<div class="details-card">
                <div class="icon"><i class="fa-solid fa-paper-plane"></i></div>
                <h2>রিকোয়েস্ট পাঠানো হয়েছে!</h2>
                <p>আপনার রিকোয়েস্টটি পর্যালোচনার জন্য পাঠানো হয়েছে।</p>
                <div class="summary">
                    <div class="summary-item"><span>অ্যামাউন্ট:</span><strong>৳ ${requestData.amount.toFixed(2)}</strong></div>
                    <div class="summary-item"><span>পেমেন্ট মেথড:</span><strong>${requestData.paymentMethod}</strong></div>
                    <div class="summary-item"><span>আপনার নম্বর:</span><strong>${requestData.userPaymentNumber}</strong></div>
                    <div class="summary-item"><span>ট্রানজেকশন আইডি:</span><strong>${requestData.transactionId}</strong></div>
                </div>
            </div>`;
        showScreen('moneyRequestSuccessScreen');
    }

    function initializeAddMoneyScreen() {
        document.getElementById('addMoneyAmount').value = '';
        document.getElementById('addMoneyUserPaymentNumber').value = '';
        document.getElementById('addMoneyTransactionId').value = '';
        document.getElementById('addMoneyPaymentDetailsSection').style.display = 'none';
        selectedAddMoneyPayment = null;
        document.querySelectorAll('#addMoneyPaymentGrid .payment-item.selected').forEach(el => el.classList.remove('selected'));
    }

    async function loadGamesFromFirestore() {
        try {
            const snapshot = await db.collection('games').where('status', '==', 'active').get();
            gamesFromDB = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            populateGameGrid();
        } catch (error) { console.error("Error fetching games: ", error); }
    }

    // MODIFIED: Group games by category and create dynamic sections with RANKING
    function populateGameGrid() {
        const container = document.getElementById('homeCategoriesContainer');
        container.innerHTML = '';
        
        // Group games by category
        const groupedGames = {};
        gamesFromDB.forEach(game => {
            const category = game.category || "জনপ্রিয় গেমসমূহ"; // Default category if none exists
            if (!groupedGames[category]) {
                groupedGames[category] = [];
            }
            groupedGames[category].push(game);
        });

        // Feature 1: Sort Categories by Rank
        // Logic: Find minimum rank in a group, use that to sort categories. 
        // Default rank 999 if not defined.
        const sortedCategories = Object.keys(groupedGames).sort((a, b) => {
            const getRank = (cat) => {
                const games = groupedGames[cat];
                // Assuming any game in the category has the categoryRank or we take the first one
                const rank = games[0].categoryRank !== undefined ? parseInt(games[0].categoryRank) : 999;
                return rank;
            };
            return getRank(a) - getRank(b);
        });

        // Loop through sorted categories and render
        sortedCategories.forEach(category => {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'category-section';
            
            const titleHtml = `<h2 class="section-title">${category}</h2>`;
            const gridDiv = document.createElement('div');
            gridDiv.className = 'game-grid';

            groupedGames[category].forEach(game => {
                const card = document.createElement('div');
                card.className = 'game-card';
                // Feature 1: Updated Badge Display logic (No substring limit, better for emojis)
                const badgeHtml = game.badgeText 
                    ? `<span class="card-badge">${game.badgeText}</span>` 
                    : '';

                card.innerHTML = `${badgeHtml}
                                  <div class="icon-wrapper"><img src="${game.logo}" alt="${game.name}"></div>
                                  <div class="game-info-container">
                                      <div class="game-name">${game.name}</div>
                                  </div>`;
                card.onclick = () => selectGame(game);
                gridDiv.appendChild(card);
            });

            sectionDiv.innerHTML = titleHtml;
            sectionDiv.appendChild(gridDiv);
            container.appendChild(sectionDiv);
        });
    }

    function selectGame(game) {
        selectedGameData = game;
        document.getElementById('gameTitle').innerText = game.name;
        document.getElementById('gameBanner').src = game.banner;

        // MODIFIED: Dynamic Input Label (Email or Player ID)
        const inputLabel = document.getElementById('inputStepTitle');
        const inputField = document.getElementById('playerId');
        // Assuming admin saves 'inputType' as 'email' for subscriptions
        const inputType = game.inputType || 'userid'; 
        
        if (inputType === 'email') {
             inputLabel.innerHTML = '<span class="step-number">1</span>আপনার ইমেইল দিন';
             inputField.placeholder = 'এখানে ইমেইল লিখুন';
        } else {
             inputLabel.innerHTML = '<span class="step-number">1</span>আপনার প্লেয়ার আইডি দিন';
             inputField.placeholder = 'এখানে প্লেয়ার আইডি লিখুন';
        }

        // MODIFIED: Show Description Box logic
        const descContainer = document.getElementById('gameDescriptionContainer');
        const descText = document.getElementById('gameDescriptionText');
        
        if(game.description && game.description.trim() !== '') {
            descText.innerText = game.description;
            descContainer.style.display = 'block';
        } else {
            descContainer.style.display = 'none';
        }

        const packageGrid = document.getElementById('packageGrid');
        packageGrid.innerHTML = '';
        
        // Feature 3: Reset Quantity when game changes
        currentQuantity = 1;
        updateQuantityUI();

        if (Array.isArray(game.packages)) {
            game.packages.forEach(pkg => {
                const item = document.createElement('div');
                
                // Feature 4 & 2: REVISED Stock Logic
                // Rule 1: If admin inputs "0" (String or Number), it is NOT stock out.
                // Rule 2: If stock is depleted (usually implies negative in this logic context) or marked.
                // Since we can't see the backend logic, we assume standard behavior:
                // Check if stock exists AND stock is NOT "0" AND stock is <= 0.
                const stockVal = parseInt(pkg.stock);
                const isStockOut = (pkg.stock !== undefined && pkg.stock !== "" && String(pkg.stock) !== "0" && !isNaN(stockVal) && stockVal <= 0);
                
                if (isStockOut) {
                    item.className = 'package-item disabled';
                    // Note: Stock quantity is HIDDEN as requested
                    item.innerHTML = `<div class="amount">${pkg.amount}</div><div class="price">৳ ${pkg.price}</div><span class="stock-tag">Sold Out</span>`;
                    // No onclick event for stock out items
                } else {
                    item.className = 'package-item';
                    item.innerHTML = `<div class="amount">${pkg.amount}</div><div class="price">৳ ${pkg.price}</div>`;
                    item.onclick = () => {
                        document.querySelectorAll('.package-item.selected').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                        selectedPackage = pkg;
                        currentQuantity = 1; // Reset quantity on package selection
                        updateQuantityUI(true); // Show quantity controls
                        
                        const priceDisplay = document.getElementById('displayPackagePrice');
                        if(priceDisplay) {
                             priceDisplay.innerText = `৳ ${(parseFloat(pkg.price) * currentQuantity).toFixed(2)}`;
                        }
                    };
                }
                packageGrid.appendChild(item);
            });
        }

        resetTopupSelections();
        showScreen('topupScreen');
    }

    // Feature 3: Quantity UI & Logic
    function updateQuantityUI(show = false) {
        const container = document.getElementById('quantityContainer');
        if (!show) {
            container.innerHTML = '';
            return;
        }
        
        container.innerHTML = `
            <div class="quantity-wrapper">
                <button class="quantity-btn" onclick="changeQuantity(-1)"><i class="fa-solid fa-minus"></i></button>
                <input type="text" class="quantity-input" id="quantityDisplay" value="${currentQuantity}" readonly>
                <button class="quantity-btn" onclick="changeQuantity(1)"><i class="fa-solid fa-plus"></i></button>
            </div>
            <p style="text-align:center; margin-top:5px; font-size: 13px; color: var(--secondary-text-color);">পরিমাণ সিলেক্ট করুন</p>
        `;
    }

    function changeQuantity(change) {
        if (!selectedPackage) return;
        
        let newQuantity = currentQuantity + change;
        if (newQuantity < 1) newQuantity = 1;
        
        // Optional: Check Stock limit if needed (e.g. max quantity based on stock)
        // Note: Logic adjusted to ignore stock check if it's "0" (unlimited)
        if (selectedPackage.stock && String(selectedPackage.stock) !== "0" && parseInt(selectedPackage.stock) < newQuantity) {
            alert("দুঃখিত! স্টকে পর্যাপ্ত পরিমাণ নেই।");
            return;
        }

        currentQuantity = newQuantity;
        document.getElementById('quantityDisplay').value = currentQuantity;
        
        // Update price display everywhere
        const total = (parseFloat(selectedPackage.price) * currentQuantity).toFixed(2);
        const priceDisplays = document.querySelectorAll('#displayPackagePrice');
        priceDisplays.forEach(el => el.innerText = `৳ ${total}`);
    }

    function resetTopupSelections() {
        const playerIdInput = document.getElementById('playerId');
        if (playerIdInput) playerIdInput.value = '';

        const userPaymentNumber = document.getElementById('userPaymentNumber');
        if (userPaymentNumber) userPaymentNumber.value = '';

        const transactionId = document.getElementById('transactionId');
        if (transactionId) transactionId.value = '';

        const paymentDetailsSection = document.getElementById('paymentDetailsSection');
        if (paymentDetailsSection) {
            paymentDetailsSection.style.display = 'none';
            paymentDetailsSection.innerHTML = ''; 
        }

        selectedPackage = null;
        selectedPayment = null;
        updateQuantityUI(false); // Hide quantity initially
        document.querySelectorAll('.package-item.selected, .payment-item.selected').forEach(el => el.classList.remove('selected'));
    }

    const slider = document.querySelector('.slider');
    let currentSlide = 0, slideInterval;

    function updateSliderPosition() {
        if (!slider) return;
        slider.style.transform = `translateX(-${currentSlide * 100}%)`;
    }
    function nextSlide() {
        const totalSlides = slider.children.length;
        if (totalSlides === 0) return;
        currentSlide = (currentSlide + 1) % totalSlides;
        updateSliderPosition();
    }

    async function loadSlider() {
        try {
            const doc = await db.collection('settings').doc('slider').get();
            slider.innerHTML = '';
            if (doc.exists && doc.data().imageUrls) {
                const imageUrls = doc.data().imageUrls;
                imageUrls.forEach(url => {
                    if(url){
                       const slideDiv = document.createElement('div');
                       slideDiv.className = 'slide';
                       slideDiv.innerHTML = `<img src="${url}" alt="Promo Banner">`;
                       slider.appendChild(slideDiv);
                    }
                });
            }
        } catch (error) {
            console.error("Error loading slider images:", error);
        } finally {
            clearInterval(slideInterval);
            if (slider.children.length > 1) {
                slideInterval = setInterval(nextSlide, 3000);
            }
        }
    }
    
    function formatMessage(text) {
        let formattedText = text;
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const emailRegex = /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi;
        const phoneRegex = /\b(\+?88)?01[3-9][0-9]{8}\b/g;

        formattedText = formattedText.replace(urlRegex, '<a href="$1" target="_blank">$1</a>');
        formattedText = formattedText.replace(emailRegex, '<a href="mailto:$&">$&</a>');
        formattedText = formattedText.replace(phoneRegex, '<a href="tel:$&">$&</a>');
        
        return formattedText;
    }

    // Support Chat Logic
    const supportModal = document.getElementById('supportModal');
    const supportBtn = document.getElementById('supportBtn');
    const supportCloseBtn = document.getElementById('supportCloseBtn');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const supportMessageInput = document.getElementById('supportMessageInput');
    const supportChatBody = document.getElementById('supportChatBody');
    let unsubscribeSupportChat;

    supportBtn.onclick = () => {
        supportModal.style.display = "flex";
        if (unsubscribeSupportChat) unsubscribeSupportChat(); 

        unsubscribeSupportChat = db.collection('supportMessages')
            .where('userId', '==', currentUser.uid)
            .onSnapshot(snapshot => {
                supportChatBody.innerHTML = '';
                if (snapshot.empty) {
                    supportChatBody.innerHTML = '<p style="text-align:center; color: var(--secondary-text-color);">আপনার প্রশ্ন এখানে লিখুন</p>';
                }
                
                let messages = [];
                snapshot.forEach(doc => messages.push(doc.data()));
                
                messages.sort((a, b) => {
                     const timeA = a.timestamp ? a.timestamp.seconds : 0;
                     const timeB = b.timestamp ? b.timestamp.seconds : 0;
                     return timeA - timeB;
                });

                messages.forEach(messageData => {
                    const messageDiv = document.createElement('div');
                    const container = document.createElement('div');
                    container.className = 'message-container';
                    messageDiv.className = `message ${messageData.sender}`;
                    messageDiv.innerHTML = formatMessage(messageData.message);
                    container.appendChild(messageDiv);
                    supportChatBody.appendChild(container);
                });
                supportChatBody.scrollTop = supportChatBody.scrollHeight;
            });
    };

    supportCloseBtn.onclick = () => {
        supportModal.style.display = "none";
        if (unsubscribeSupportChat) {
            unsubscribeSupportChat();
            unsubscribeSupportChat = null;
        }
    };

    sendMessageBtn.onclick = async () => {
        const message = supportMessageInput.value.trim();
        if (message === '') return;
        supportMessageInput.value = '';

        await db.collection('supportMessages').add({
            userId: currentUser.uid,
            userName: currentUser.displayName || currentUser.email,
            message: message,
            sender: 'user',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    };

    // Dynamic Popup Modal
    const dynamicPopup = document.getElementById('dynamicPopup');
    const popupCloseBtn = document.getElementById('popupCloseBtn');

    function initializePopupListener() {
        db.collection('settings').doc('popup').onSnapshot(doc => {
            const popupViewed = sessionStorage.getItem('popupViewed');
            // Remove popupViewed check for testing, or keep it if strictly per session
            // FIX 3: Removed check to verify visual fix, or rely on user to clear cache. 
            // Better: Ensure z-index works.
            if (doc.exists && doc.data().isActive && !popupViewed) {
                const data = doc.data();
                document.getElementById('popupTitle').textContent = data.title || '';
                document.getElementById('popupMessage').textContent = data.message || '';
                const popupImage = document.getElementById('popupImage');
                
                // FIX 3: Button Logic
                const actionButton = document.getElementById('popupActionButton');
                if (data.buttonLink) {
                    actionButton.href = data.buttonLink;
                    actionButton.innerText = data.buttonText || 'Tap Here';
                    actionButton.style.display = 'inline-block';
                } else {
                    actionButton.style.display = 'none';
                }

                if (data.imageUrl) {
                    popupImage.src = data.imageUrl;
                    popupImage.style.display = 'block';
                } else {
                    popupImage.style.display = 'none';
                }
                dynamicPopup.style.display = 'flex';
            }
        });
    }
    popupCloseBtn.onclick = () => {
        dynamicPopup.style.display = 'none';
        sessionStorage.setItem('popupViewed', 'true');
    };
    
    // Online Status Listener
    function initializeOnlineStatusListener() {
        const statusIndicator = document.getElementById('onlineStatus');
        const statusText = document.getElementById('onlineStatusText');

        db.collection('settings').doc('onlineStatus').onSnapshot(doc => {
            if (doc.exists && doc.data().isOnline) {
                statusIndicator.classList.remove('offline');
                statusIndicator.classList.add('online');
                statusText.innerText = 'Online';
            } else {
                statusIndicator.classList.remove('online');
                statusIndicator.classList.add('offline');
                statusText.innerText = 'Offline';
            }
        });
    }
</script>
<script type='text/javascript' src='//pl28152429.effectivegatecpm.com/2f/97/6b/2f976b50e943f5f8b433723f8165c6f3.js'></script>
</body>
</html>
